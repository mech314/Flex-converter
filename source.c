/*******************************************************
  Standart GM sensor outputs 50-150Hz as a signal for EtOH content. 
  This MC will conver HZ to voltage for ECU to blend maps in flex-fuel setup.
  Output from 0.5 to 4.5V. 

  Input pin 8 (PB0) ICP1 (interupt) on Atmega328
  Output pin 11

********************************************************/
#include <Adafruit_SSD1306.h>
#include <splash.h>
#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128 // Display widht
#define SCREEN_HEIGHT 64 // Display height
#define OLED_RESET     4 // Reset pin #
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Start logo
const unsigned char StartLogo [] PROGMEM = {
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xfc, 0x3f, 0x01, 0x9c, 0x78, 0x38, 0x02, 0x07, 0x80, 
	0x00, 0x80, 0xc0, 0xff, 0xc0, 0xff, 0xfc, 0x3f, 0x01, 0x98, 0xf0, 0x18, 0x02, 0x07, 0x00, 0x00, 
	0x80, 0xc0, 0x7f, 0xc0, 0xff, 0xfc, 0x1f, 0x31, 0x98, 0xe3, 0x8f, 0x3e, 0x7e, 0x1d, 0xc7, 0x8f, 
	0xce, 0x3f, 0xc0, 0xff, 0xf8, 0x1f, 0x31, 0x91, 0xe3, 0x8f, 0x3e, 0x7e, 0x3f, 0xc7, 0x8f, 0xce, 
	0x3f, 0xc0, 0xff, 0xf8, 0x9f, 0x31, 0x83, 0xe7, 0x8f, 0x3e, 0x06, 0x3f, 0xc7, 0x80, 0xce, 0x3f, 
	0xc0, 0xff, 0xf8, 0x9f, 0x31, 0x81, 0xe7, 0xcf, 0x3e, 0x06, 0x7f, 0xc7, 0x80, 0xc0, 0x7f, 0xc0, 
	0xff, 0xf9, 0x8f, 0x31, 0x81, 0xe7, 0x8f, 0x3e, 0x06, 0x7f, 0xc7, 0x81, 0xc0, 0x7f, 0xc0, 0xff, 
	0xf0, 0x0e, 0x31, 0x88, 0xe3, 0x8f, 0x3e, 0x7e, 0x3f, 0xc7, 0x8f, 0xc7, 0xff, 0xc0, 0xff, 0xf0, 
	0x0e, 0x31, 0x98, 0xe3, 0x8f, 0x3e, 0x7e, 0x3d, 0xc7, 0x8f, 0xcf, 0xff, 0xc0, 0xff, 0xf1, 0xc4, 
	0x71, 0x9c, 0x60, 0x1f, 0x3e, 0x07, 0x01, 0xc7, 0x80, 0xcf, 0xff, 0xc0, 0xff, 0xe3, 0xc4, 0xf1, 
	0x9e, 0x30, 0x3f, 0x3e, 0x07, 0x81, 0xc7, 0x80, 0xcf, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfc, 0x7f, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0
};

int inpPin = 8;     //input pin 8
int outPin = 11;    // PWM output
volatile uint16_t revTick;    //Ticks per rev
uint16_t pwm_output  = 0;     //storing PWM value
int HZ;                       //storing HZ input
int ethanol = 0;              //ethanol percentage 
uint16_t voltage = 0;         //voltage percentage
float expectedv;              //expected voltage - range for typical GM sensors is 0.5-4.5v

int duty;                     //Duty cycle (0.0-100.0)
float period;                 // period time here (eg.0.0025 s)
float temperature = 0;        // fuel temperature here
int cels = 0;
static long highTime = 0;     // Settings for temperature
static long lowTime = 0;
static long tempPulse;

void setupTimer() {   //  timer1
  TCCR1A = 0;      // 
  TCCR1B = 132;    // (10000100) Falling edge trigger, Timer = CPU Clock/256, noise cancellation on
  TCCR1C = 0;      // 
  TIMSK1 = 33;     // (00100001) Input capture and overflow interupts enabled
  TCNT1 = 0;       // start from 0
}

ISR(TIMER1_CAPT_vect) {    // Interupt when pulse is detecte
  revTick = ICR1;      // save duration
  TCNT1 = 0;       // restart timer
}

ISR(TIMER1_OVF_vect) {    // counter overflow/timeout
  revTick = 0;  // Ticks per second = 0
}

void setup() {
  Serial.begin(9600);
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { //
    Serial.println(F("SSD1306 allocation failed"));
    for (;;);
  }
  display.clearDisplay();
  display.drawBitmap(0, 0, StartLogo, 120, 62, WHITE);

  // Update the display
  display.display();
  delay(2000); 
  display.clearDisplay();
  display.display();
  // END OLED
  pinMode(inpPin, INPUT);
  setPwmFrequency(); //Modify frequency on PWM output
  setupTimer();
}

void loop() {

  getfueltemp(inpPin); //read fuel temp from duty cycle

  if (revTick > 0) {
    HZ = 62200 / revTick; // 3456000ticks per minute, 57600 per second
  }
  else {
    HZ = 0;
  }

  //calculate ethanol percentage
  if (HZ > 50) { // Avoid dividing by zero
    ethanol = (HZ - 50);
  }
  else {
    ethanol = 0;
  }

  if (ethanol > 99) { // Avoid overflow in PWM
    ethanol = 99;
  }

  expectedv = ((((HZ - 50.0) * 0.01) * 4) + 0.5);
  //Screen calculations
  pwm_output = 1.05 * (255 * (expectedv / 5.0)); //calculate output PWM for ECU. Here You need to play a little to reach correct values. MAke sure not to adjust multiplier too much. 
  // OLED Code
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.print("EtOH:   %");
  display.setCursor(0, 20);
  display.print("   Hz    C");
  display.setCursor(0, 40);
  display.print("     V");
  display.setCursor(60, 0);
  display.print(ethanol);
  display.setCursor(0, 20);
  display.print(HZ);
  display.setCursor(70, 20);
  display.print((int)temperature); //Use this for celsius
  display.setCursor(0, 40);
  display.print(expectedv);
  display.display();

  //PWM output
  analogWrite(outPin, pwm_output); //write the PWM value to output 

  delay(100);

  Serial.println(ethanol);
  Serial.println(pwm_output);
  Serial.println(expectedv);
  Serial.println(HZ);
  Serial.println(temperature);
  delay(1000);
}

void getfueltemp(int inpPin) { //read fuel temp from input duty cycle
  highTime = 0;
  lowTime = 0;

  tempPulse = pulseIn(inpPin, HIGH);
  if (tempPulse > highTime) {
    highTime = tempPulse;
  }

  tempPulse = pulseIn(inpPin, LOW);
  if (tempPulse > lowTime) {
    lowTime = tempPulse;
  }

  duty = ((100 * (highTime / (double (lowTime + highTime))))); //Calculate duty cycle
  float T = (float(1.0 / float(HZ)));           //Calculate total period time
  float period = float(100 - duty) * T;         //Calculate the active period time (100-duty)*T
  float temp2 = float(10) * float(period);      //Convert ms to whole number
  temperature = ((40.25 * temp2) - 81.25);      //Calculate temperature 
  int cels = int(temperature);
  cels = cels * 0.1;
}

void setPwmFrequency() { //update pwm timer
  byte mode;                                 
  mode = 0x01;
  TCCR2B = TCCR2B & 0b11111000 | mode;
}
